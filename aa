If String.IsNullOrEmpty(fileName) Then
    fileName = "export"
End If

fileName = $"{fileName}_{DateTime.Now.ToString("yyyy-MM-dd_HH-mm-ss")}.csv"

response.Clear()
response.Buffer = True
response.ClearContent()
response.ClearHeaders()
response.Charset = ""
response.ContentEncoding = Encoding.GetEncoding("windows-1252")

response.Cache.SetCacheability(HttpCacheability.NoCache)
response.ContentType = "text/csv"
response.AddHeader("Content-Disposition", "attachment;filename=" & fileName)

Dim sb As New StringBuilder()

For i As Integer = 0 To gv.Columns.Count - 1
    sb.Append($"{gv.Columns(i).HeaderText}{delimiter}")
Next

sb.AppendLine()

For i As Integer = 0 To gv.Rows.Count - 1
    For j As Integer = 0 To gv.Columns.Count - 1
        Dim cellValue As String = gv.Rows(i).Cells(j).Text.Trim()
        cellValue = cellValue.Replace("""", """""")

        If Regex.IsMatch(cellValue, $"[{delimiter}""\n]") Then
            cellValue = $"""{cellValue}"""
        End If

        sb.Append($"{cellValue}{delimiter}")
    Next

    sb.AppendLine()
Next

response.Write(sb.ToString())
response.[End]()
