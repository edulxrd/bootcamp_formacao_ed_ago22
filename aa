If String.IsNullOrEmpty(idfile) Then
    idfile = "export"
End If

Dim FileName As String = $"{idfile}_" & DateTime.Now & ".csv"

Dim sb As New StringBuilder()

Dim auxLine As String = ""
For Each column As DataColumn In dataTable.Columns
    auxLine &= $"{column.ColumnName}{delimiter}"
Next

sb.AppendLine(auxLine.Substring(0, auxLine.Length - 1))

Dim dataStr As String = ""
For Each row As DataRow In dataTable.Rows
    auxLine = ""
    For Each dataValue In row.ItemArray
        dataStr = dataValue.ToString()

        dataStr = dataStr.Replace("""", """""")

        If Regex.IsMatch(dataStr, $"[{delimiter}""\n]") Then
            dataStr = $"""{dataStr}"""
        End If

        auxLine &= $"{dataStr}{delimiter}"
    Next

    sb.AppendLine(auxLine.Substring(0, auxLine.Length - 1))
Next

response.Clear()
response.Buffer = True
response.ClearContent()
response.ClearHeaders()
response.Charset = ""
response.ContentEncoding = Encoding.GetEncoding("windows-1252")

response.Cache.SetCacheability(HttpCacheability.NoCache)
response.ContentType = "text/csv"
response.AddHeader("Content-Disposition", "attachment;filename=" & FileName)

Dim strwritter As New StringWriter(sb)

response.Write(strwritter.ToString())
response.[End]()
 